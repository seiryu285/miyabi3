<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MIYABI - Japanese Art NFT Collection | Gallery</title>
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500&display=swap" rel="stylesheet">
  <style>
    /* Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: "Yu Mincho", "YuMincho", serif;
      background-color: #ffffff;
      overflow-x: hidden;
      color: #333;
      forced-color-adjust: none;
    }
    /* Navigation (for gallery page) */
    .nav {
      position: fixed;
      top: 30px;
      right: 50px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 30px;
    }
    .nav a {
      color: white;
      text-decoration: none;
      font-size: 18px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
      font-family: 'Rajdhani', sans-serif;
    }
    .nav a:hover {
      color: #FFD700;
    }
    /* 言語選択タブの背景・境界線 */
    .nav .lang-select {
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-family: 'Rajdhani', sans-serif;
      cursor: pointer;
    }
    .nav .connect-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 20px;
      border-radius: 4px;
      font-family: 'Rajdhani', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .nav .connect-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    /* Gallery container */
    .gallery-container {
      padding: 2rem;
      margin-top: 140px;
      background-color: #ffffff;
    }
    /* ギャラリーのグリッド */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .gallery-item {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .gallery-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .gallery-item img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
    }
    .gallery-item-number {
      position: absolute;
      top: 1rem;
      left: 1rem;
      font-family: 'Rajdhani', sans-serif;
      font-size: 0.875rem;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      z-index: 2;
    }
    /* NFT Detail Modal */
    .nft-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    .nft-modal::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: -1;
    }
    .modal-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      transition: background-color 0.3s ease;
      z-index: -2;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: none;
    }
    @media (max-width: 768px) {
      .modal-overlay {
        display: block;
      }
    }
    .nft-modal.active {
      opacity: 1;
      display: flex;
    }
    .modal-content {
      position: relative;
      width: 95%;
      max-width: 1400px;
      height: 90vh;
      display: flex;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 24px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    /* Fullscreen for video on mobile */
    @media (max-width: 768px) {
      .modal-content.video-active {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
      }
      .modal-content.video-active .modal-info {
        display: none;
      }
      .modal-content.video-active .modal-image video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        border-radius: 0;
      }
    }
    /* Desktop optimization for video */
    @media (min-width: 769px) {
      .modal-content.video-active {
        width: 90%;
        height: 80vh;
        border-radius: 12px;
        margin: auto;
      }
      .modal-content.video-active .modal-info {
        display: none;
      }
      .modal-content.video-active .modal-image video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 12px;
      }
    }
    .modal-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: transparent;
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.3s ease;
      z-index: 100;
      padding: 0;
      line-height: 1;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    @media (hover: hover) and (pointer: fine) {
      .modal-close:hover {
        color: #FFD700;
      }
    }
    .modal-inner {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 2rem;
      padding: 1.5rem;
    }
    .modal-image {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      max-height: 100%;
      padding: 1rem;
      position: relative;
    }
    .modal-image img,
    .modal-image video {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
      border-radius: 16px;
    }
    /* Note: video tag does not include controls attribute so no native UI is shown */
    .modal-info {
      width: 400px;
      height: 100%;
      padding: 1.5rem;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .collection-row {
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      letter-spacing: 0.5px;
      opacity: 0.9;
      margin-bottom: 0.75rem;
    }
    .modal-title {
      font-size: 2rem;
      line-height: 1.3;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    .modal-description {
      line-height: 1.8;
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.9);
      white-space: pre-line;
      margin-bottom: 2rem;
    }
    .modal-traits {
      margin-bottom: 2rem;
    }
    .modal-traits h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .trait-item {
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .trait-type {
      font-weight: 500;
      opacity: 0.8;
    }
    .modal-details {
      font-size: 1rem;
    }
    .detail-item {
      margin-bottom: 0.75rem;
    }
    .detail-label {
      opacity: 0.8;
    }
    .modal-info::-webkit-scrollbar {
      width: 8px;
    }
    .modal-info::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    .modal-info::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }
    .modal-info::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    @media (max-width: 1024px) {
      .modal-inner {
        flex-direction: column;
        gap: 1.5rem;
      }
      .modal-info {
        width: 100%;
        max-height: 50vh;
      }
      .modal-image {
        padding: 0;
      }
      .modal-image img,
      .modal-image video {
        max-height: 40vh;
      }
      .modal-title {
        font-size: 1.75rem;
      }
      .modal-description {
        font-size: 1rem;
      }
    }
    @media (max-width: 768px) {
      .nav {
        right: 20px;
        top: 20px;
        gap: 15px;
      }
      .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      .nft-modal {
        padding: 1rem;
      }
      .modal-content {
        height: 100vh;
        width: 100vw;
        border-radius: 0;
      }
      .modal-inner {
        padding: 1rem;
        gap: 1rem;
      }
      .modal-close {
        top: 1rem;
        right: 1rem;
        width: 36px;
        height: 36px;
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <select class="lang-select">
      <option value="ja">JP</option>
      <option value="en" selected>EN</option>
    </select>
    <button class="connect-btn" data-translate="connectWallet">CONNECT</button>
    <!-- 追加：没入体験へ移動するタブ -->
    <a href="immersive.html" data-translate="enterWorld">ENTER</a>
    <a href="gallery.html" class="gallery-link" data-translate="gallery">VIEW GALLERY</a>
    <a href="about.html" data-translate="about">ABOUT</a>
  </nav>

  <!-- Gallery Container -->
  <div class="gallery-container">
    <div class="gallery-grid">
      <!-- NFT items are 生成 via JS -->
    </div>
  </div>

  <!-- NFT Detail Modal -->
  <div class="nft-modal" id="nftModal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-background"></div>
      <button class="modal-close">×</button>
      <div class="modal-inner">
        <div class="modal-image">
          <!-- 初期表示は画像、動画は非表示 -->
          <img id="modalImage" src="" alt="NFT Detail">
          <video id="modalVideo" style="display: none;" playsinline></video>
        </div>
        <div class="modal-info">
          <div class="modal-header">
            <div class="collection-row">
              <span class="collection-label" id="modalCollection"></span>
              <span id="modalNumber"></span>
            </div>
            <h2 class="modal-title" id="modalTitle"></h2>
          </div>
          <div class="modal-description" id="modalDescription"></div>
          <div class="modal-traits" id="modalTraits"></div>
          <div class="modal-details">
            <div class="detail-item">
              <span class="detail-label" data-translate="details.style">Style:</span>
              <span class="detail-value" id="modalStyle"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label" data-translate="details.method">Method:</span>
              <span class="detail-value" id="modalMethod"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label" data-translate="details.accessory">Accessory:</span>
              <span class="detail-value" id="modalAccessory"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Web3 Library -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
  <!-- Color Thief Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
  <script>
    // グローバルエラーハンドラー（予期せぬエラーをキャッチ）
    window.addEventListener('error', function(e) {
      console.error("Global error caught:", e.error || e.message);
    });

    // 翻訳用オブジェクト
    const translations = {
      en: {
        connectWallet: "CONNECT",
        gallery: "VIEW GALLERY",
        about: "ABOUT",
        enterWorld: "ENTER",
        search: "Search by name or number...",
        ui: {
          all: "All",
          recent: "Recent",
          popular: "Popular",
          trending: "Trending"
        },
        details: {
          style: "Style:",
          method: "Method:",
          accessory: "Accessory:"
        },
        traitsTitle: "Traits"
      },
      ja: {
        connectWallet: "ウォレット接続",
        gallery: "ギャラリーを見る",
        about: "このプロジェクトについて",
        enterWorld: "没入体験",
        search: "名前または番号で検索...",
        ui: {
          all: "すべて",
          recent: "新着",
          popular: "人気",
          trending: "トレンド"
        },
        details: {
          style: "スタイル:",
          method: "制作技法:",
          accessory: "装飾:"
        },
        traitsTitle: "特性"
      }
    };

    let currentLang = "en";

    document.addEventListener('DOMContentLoaded', function() {
      // NFTデータ定義 (#1～#30)
      const nftData = [
        {
          id: 1,
          title: "MIYABI #001: Aonami - The Inheritor of Ripples",
          description_en: "Aonami, hailing from a lineage of Kamakura textile artisans, upholds the ancient art of indigo dyeing. Calm as a deep ocean, he channels a fervent passion to fuse digital art with traditional techniques.",
          description_ja: "青波は鎌倉の染織職人の家系に生まれ、古来の藍染技法を受け継いでいます。深海のような静けさを持ちながら、デジタルアートと伝統技法の融合に情熱を注ぐ。",
          image: "assets/nft1.jpg",
          video: "assets/nft1.mp4",
          style: "Contemporary Shibori",
          method: "Digital Painting & Dyeing Fusion",
          accessory: "Kimono with Wave Pattern",
          collection: "MIYABI",
          traits: {
            personality_en: "Calm & Passionate",
            personality_ja: "穏やかで情熱的",
            specialty_en: "Indigo Dyeing",
            specialty_ja: "藍染",
            currentBase_en: "Tokyo",
            currentBase_ja: "東京",
            fourCharacterIdiom_en: "Aosio Dream Rhyme",
            fourCharacterIdiom_ja: "青藍夢韻"
          }
        },
        // #2～#10 のデータ（省略）
        {
          id: 2,
          title: "MIYABI #002: Kakurin - The Swordmaster of Tradition",
          description_en: "Kakurin, descendant of a samurai lineage bearing the crane emblem, has been trained in swordsmanship since childhood.",
          description_ja: "鶴凛は鶴の家紋を持つ武家の末裔で、幼少より剣の修行を積んでいる。",
          image: "assets/nft2.jpg",
          video: "",
          style: "Samurai Urban",
          method: "Traditional Swordsmanship + Modern Security",
          accessory: "Crane Emblem",
          collection: "MIYABI",
          traits: {
            personality_en: "Polite & Proud",
            personality_ja: "礼儀正しく誇り高い",
            specialty_en: "Swordsmanship",
            specialty_ja: "剣術",
            currentBase_en: "Metropolis",
            currentBase_ja: "大都市",
            fourCharacterIdiom_en: "Crane Shadow Blade",
            fourCharacterIdiom_ja: "鶴影剣"
          }
        },
        // #3～#30 のデータ（省略）
      ];

      // エラーハンドリング付きの openModal 関数
      function openModal(nft) {
        try {
          const modal = document.getElementById('nftModal');
          if (!modal) return;
          const modalImg = document.getElementById('modalImage');
          const modalVideo = document.getElementById('modalVideo');
          const modalInfo = document.querySelector('.modal-info');
          const modalContent = document.querySelector('.modal-content');
          // 初期状態：画像＋詳細情報表示、動画は非表示
          if(modalImg) {
            modalImg.style.display = 'block';
          }
          if(modalVideo) {
            modalVideo.style.display = 'none';
          }
          if(modalInfo) {
            modalInfo.style.display = '';
          }
          if(modalContent) {
            modalContent.classList.remove('video-active');
          }

          if(modalImg) {
            modalImg.src = nft.image;
            modalImg.alt = nft.title;
          }
          if(modalVideo) {
            modalVideo.src = nft.video ? nft.video : "";
          }
          const modalCollectionElem = document.getElementById('modalCollection');
          const modalNumberElem = document.getElementById('modalNumber');
          if (modalCollectionElem) {
              modalCollectionElem.textContent = nft.collection ? nft.collection.toUpperCase() : 'MIYABI';
          }
          if (modalNumberElem) {
              modalNumberElem.textContent = "#" + String(nft.id).padStart(4, '0');
          }
          document.getElementById('modalTitle').textContent = nft.title;
          // 説明文、style, method, accessory は現在の言語に応じて
          document.getElementById('modalDescription').textContent = nft["description_" + currentLang];
          document.getElementById('modalStyle').textContent = nft["style_" + currentLang] || nft.style;
          document.getElementById('modalMethod').textContent = nft["method_" + currentLang] || nft.method;
          document.getElementById('modalAccessory').textContent = nft["accessory_" + currentLang] || nft.accessory;
          updateTraits(nft);
          
          // 画像読み込み後、背景色抽出（Color Thief 利用例）
          if(modalImg) {
            modalImg.onload = function() {
              try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = modalImg.width;
                canvas.height = modalImg.height;
                ctx.drawImage(modalImg, 0, 0);
                const imageData = ctx.getImageData(0, 0, 1, 1).data;
                const bgColor = "rgb(" + imageData[0] + ", " + imageData[1] + ", " + imageData[2] + ")";
                const modalBg = document.querySelector('.modal-background');
                if (modalBg) {
                    modalBg.style.backgroundColor = bgColor;
                }
                if (window.innerWidth <= 768) {
                    const modalOverlay = document.querySelector('.modal-overlay');
                    if (modalOverlay) {
                        modalOverlay.style.backgroundColor = bgColor;
                    }
                }
              } catch (e) {
                console.error("Error extracting background color:", e);
              }
            };
          }

          // 画像クリックで動画表示（動画が存在する場合）
          if(modalImg) {
            modalImg.onclick = function() {
              if(nft.video && modalVideo && modalVideo.src) {
                modalImg.style.display = 'none';
                modalVideo.style.display = 'block';
                if(modalInfo) {
                  modalInfo.style.display = 'none';
                }
                if(modalContent) {
                  modalContent.classList.add('video-active');
                }
                modalVideo.play().catch(err => console.error("Video play error:", err));
              }
            };
          }
          // 動画クリックで画像＋詳細情報表示に戻す
          if(modalVideo) {
            modalVideo.onclick = function() {
              modalVideo.pause();
              modalVideo.style.display = 'none';
              if(modalImg) {
                modalImg.style.display = 'block';
              }
              if(modalInfo) {
                modalInfo.style.display = '';
              }
              if(modalContent) {
                modalContent.classList.remove('video-active');
              }
            };
          }

          modal.style.display = 'flex';
          setTimeout(() => { modal.classList.add('active'); }, 10);
          document.body.style.overflow = 'hidden';
          setupModalEventListeners(modal);
        } catch (error) {
          console.error("Error in openModal:", error);
        }
      }

      function updateTraits(nft) {
        try {
          const modalTraits = document.getElementById('modalTraits');
          if (modalTraits && nft.traits) {
              const keysToShow = ["personality", "specialty", "currentBase", "fourCharacterIdiom"];
              let traitsHTML = '<h3>' + (translations[currentLang].traitsTitle || "Traits") + '</h3><div class="trait-list">';
              keysToShow.forEach(key => {
                  if(nft.traits[key + "_" + currentLang]){
                    traitsHTML += 
                      '<div class="trait-item">' +
                          '<span class="trait-type">' + getTraitLabel(key) + ':</span> ' +
                          '<span class="trait-value">' + nft.traits[key + "_" + currentLang] + '</span>' +
                      '</div>';
                  }
              });
              traitsHTML += '</div>';
              modalTraits.innerHTML = traitsHTML;
          } else if (modalTraits) {
              modalTraits.innerHTML = '';
          }
        } catch (error) {
          console.error("Error in updateTraits:", error);
        }
      }

      function getTraitLabel(key) {
          const labels = {
              personality: currentLang === "ja" ? "性格" : "Personality",
              specialty: currentLang === "ja" ? "専門" : "Specialty",
              currentBase: currentLang === "ja" ? "活動拠点" : "Base",
              fourCharacterIdiom: currentLang === "ja" ? "四字熟語" : "Idiom"
          };
          return labels[key] || key;
      }

      function setupModalEventListeners(modal) {
          try {
            const closeButton = modal.querySelector('.modal-close');
            if (closeButton) {
                closeButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                });
                closeButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal();
                });
                closeButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal();
                });
            }
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            };
            document.addEventListener('keydown', escHandler);
            modal._escHandler = escHandler;
          } catch (error) {
            console.error("Error in setupModalEventListeners:", error);
          }
      }

      function closeModal() {
          try {
            const modal = document.getElementById('nftModal');
            if (!modal) return;
            if (modal._escHandler) {
                document.removeEventListener('keydown', modal._escHandler);
                delete modal._escHandler;
            }
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
          } catch (error) {
            console.error("Error in closeModal:", error);
          }
      }

      function populateGallery() {
          try {
            const galleryGrid = document.querySelector('.gallery-grid');
            if (!galleryGrid) return;
            galleryGrid.innerHTML = '';
            nftData.forEach(nft => {
                const item = createGalleryItem(nft);
                galleryGrid.appendChild(item);
            });
          } catch (error) {
            console.error("Error in populateGallery:", error);
          }
      }

      function createGalleryItem(nft) {
          try {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.dataset.number = "#" + String(nft.id).padStart(4, '0');
            item.dataset.title = nft.title;
            const numberDiv = document.createElement('div');
            numberDiv.className = 'gallery-item-number';
            numberDiv.textContent = item.dataset.number;
            const img = document.createElement('img');
            img.src = nft.image;
            img.alt = nft.title;
            img.loading = 'lazy';
            img.onerror = function() {
                this.src = 'assets/placeholder.jpg';
            };
            item.appendChild(numberDiv);
            item.appendChild(img);
            item.addEventListener('click', () => {
                openModal(nft);
            });
            return item;
          } catch (error) {
            console.error("Error in createGalleryItem:", error);
          }
      }

      async function initializeWeb3() {
          try {
            if (typeof window.ethereum !== 'undefined') {
                window.web3 = new Web3(window.ethereum);
                const connectBtn = document.querySelector('.connect-btn');
                if (connectBtn) {
                    connectBtn.addEventListener('click', connectWallet);
                }
                window.ethereum.on('accountsChanged', handleAccountsChanged);
            }
          } catch (error) {
            console.error("Error in initializeWeb3:", error);
          }
      }

      async function connectWallet() {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            handleAccountsChanged(accounts);
          } catch (error) {
            console.error('Failed to connect wallet:', error);
          }
      }

      function handleAccountsChanged(accounts) {
          const connectBtn = document.querySelector('.connect-btn');
          if (!connectBtn) return;
          if (accounts.length === 0) {
              connectBtn.textContent = translations[currentLang].connectWallet;
          } else {
              const shortAddress = accounts[0].substring(0, 6) + "..." + accounts[0].substring(accounts[0].length - 4);
              connectBtn.textContent = shortAddress;
          }
      }

      function initializeLanguageToggle() {
          try {
            const langSelect = document.querySelector('.lang-select');
            if (langSelect) {
                langSelect.addEventListener('change', (e) => {
                    currentLang = e.target.value;
                    updateLanguage();
                });
                langSelect.addEventListener('input', (e) => {
                    currentLang = e.target.value;
                    updateLanguage();
                });
            }
            updateLanguage();
          } catch (error) {
            console.error("Error in initializeLanguageToggle:", error);
          }
      }

      function updateLanguage() {
          try {
            // data-translate属性を持つ要素の更新
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.dataset.translate;
                const translationPath = key.split('.');
                let translation = translations[currentLang];
                for (const path of translationPath) {
                    translation = translation?.[path];
                }
                if (translation) {
                    element.textContent = translation;
                }
            });
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.placeholder = translations[currentLang].search;
            }
            const connectBtn = document.querySelector('.connect-btn');
            if (connectBtn && !connectBtn.textContent.includes('0x')) {
                connectBtn.textContent = translations[currentLang].connectWallet;
            }
            // モーダル内表示中の場合、説明文・詳細情報および特性を更新
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle && modalTitle.textContent) {
                const nft = nftData.find(nft => nft.title === modalTitle.textContent);
                if (nft) {
                    document.getElementById('modalDescription').textContent = nft["description_" + currentLang];
                    document.getElementById('modalStyle').textContent = nft["style_" + currentLang] || nft.style;
                    document.getElementById('modalMethod').textContent = nft["method_" + currentLang] || nft.method;
                    document.getElementById('modalAccessory').textContent = nft["accessory_" + currentLang] || nft.accessory;
                    updateTraits(nft);
                }
            }
          } catch (error) {
            console.error("Error in updateLanguage:", error);
          }
      }

      function isMobileDevice() {
          return window.innerWidth <= 768;
      }

      function optimizeForMobile() {
          try {
            if (isMobileDevice()) {
                const galleryGrid = document.querySelector('.gallery-grid');
                if (galleryGrid) {
                    // モバイル時は1列表示に変更
                    galleryGrid.style.gridTemplateColumns = '1fr';
                }
                const modalContent = document.querySelector('.nft-modal .modal-content');
                if (modalContent) {
                    modalContent.style.gridTemplateColumns = '1fr';
                }
            }
          } catch (error) {
            console.error("Error in optimizeForMobile:", error);
          }
      }

      function debounce(func, wait) {
          let timeout;
          return function(...args) {
              clearTimeout(timeout);
              timeout = setTimeout(() => func(...args), wait);
          };
      }

      function lazyLoadImages() {
          try {
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            });
            images.forEach(img => imageObserver.observe(img));
          } catch (error) {
            console.error("Error in lazyLoadImages:", error);
          }
      }

      function handleError(error, context) {
          console.error("Error in " + context + ":", error);
          const errorContainer = document.querySelector('.error-container');
          if (errorContainer) {
              errorContainer.textContent = (currentLang === "ja" ? "エラーが発生しました: " : "An error occurred: ") + error.message;
              errorContainer.style.display = 'block';
          }
      }

      try {
          populateGallery();
          initializeLanguageToggle();
          initializeWeb3();
          optimizeForMobile();
          lazyLoadImages();
          window.addEventListener('resize', debounce(() => {
              optimizeForMobile();
          }, 250));
      } catch (error) {
          handleError(error, 'application initialization');
      }
    });
  </script>
</body>
</html>
