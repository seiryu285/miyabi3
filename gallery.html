<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MIYABI - Japanese Art NFT Collection | Gallery</title>
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500&display=swap" rel="stylesheet">
  <style>
    /* Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: "Yu Mincho", "YuMincho", serif;
      background-color: #ffffff;
      overflow-x: hidden;
      color: #333;
      forced-color-adjust: none;
    }
    /* Navigation (for gallery page) */
    .nav {
      position: fixed;
      top: 30px;
      right: 50px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 30px;
    }
    .nav a {
      color: white;
      text-decoration: none;
      font-size: 18px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
      font-family: 'Rajdhani', sans-serif;
    }
    .nav a:hover {
      color: #FFD700;
    }
    /* 言語選択タブの背景・境界線 */
    .nav .lang-select {
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-family: 'Rajdhani', sans-serif;
      cursor: pointer;
    }
    .nav .connect-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 20px;
      border-radius: 4px;
      font-family: 'Rajdhani', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .nav .connect-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    /* Gallery container */
    .gallery-container {
      padding: 2rem;
      margin-top: 140px;
      background-color: #ffffff;
    }
    /* ギャラリーのグリッド */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .gallery-item {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .gallery-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .gallery-item img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
    }
    .gallery-item-number {
      position: absolute;
      top: 1rem;
      left: 1rem;
      font-family: 'Rajdhani', sans-serif;
      font-size: 0.875rem;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      z-index: 2;
    }
    /* NFT Detail Modal */
    .nft-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    .nft-modal::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: -1;
    }
    .modal-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      transition: background-color 0.3s ease;
      z-index: -2;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: none;
    }
    @media (max-width: 768px) {
      .modal-overlay {
        display: block;
      }
    }
    .nft-modal.active {
      opacity: 1;
      display: flex;
    }
    .modal-content {
      position: relative;
      width: 95%;
      max-width: 1400px;
      height: 90vh;
      display: flex;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 24px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    /* Fullscreen for video on mobile */
    @media (max-width: 768px) {
      .modal-content.video-active {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
      }
      .modal-content.video-active .modal-info {
        display: none;
      }
      .modal-content.video-active .modal-image video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        border-radius: 0;
      }
    }
    /* Desktop optimization for video */
    @media (min-width: 769px) {
      .modal-content.video-active {
        width: 90%;
        height: 80vh;
        border-radius: 12px;
        margin: auto;
      }
      .modal-content.video-active .modal-info {
        display: none;
      }
      .modal-content.video-active .modal-image video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 12px;
      }
    }
    .modal-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: transparent;
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.3s ease;
      z-index: 100;
      padding: 0;
      line-height: 1;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    @media (hover: hover) and (pointer: fine) {
      .modal-close:hover {
        color: #FFD700;
      }
    }
    .modal-inner {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 2rem;
      padding: 1.5rem;
    }
    .modal-image {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      max-height: 100%;
      padding: 1rem;
      position: relative;
    }
    .modal-image img,
    .modal-image video {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
      border-radius: 16px;
    }
    .modal-info {
      width: 400px;
      height: 100%;
      padding: 1.5rem;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .collection-row {
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      letter-spacing: 0.5px;
      opacity: 0.9;
      margin-bottom: 0.75rem;
    }
    .modal-title {
      font-size: 2rem;
      line-height: 1.3;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    .modal-description {
      line-height: 1.8;
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.9);
      white-space: pre-line;
      margin-bottom: 2rem;
    }
    .modal-traits {
      margin-bottom: 2rem;
    }
    .modal-traits h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .trait-item {
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .trait-type {
      font-weight: 500;
      opacity: 0.8;
    }
    .modal-details {
      font-size: 1rem;
    }
    .detail-item {
      margin-bottom: 0.75rem;
    }
    .detail-label {
      opacity: 0.8;
    }
    .modal-info::-webkit-scrollbar {
      width: 8px;
    }
    .modal-info::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    .modal-info::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }
    .modal-info::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    @media (max-width: 1024px) {
      .modal-inner {
        flex-direction: column;
        gap: 1.5rem;
      }
      .modal-info {
        width: 100%;
        max-height: 50vh;
      }
      .modal-image {
        padding: 0;
      }
      .modal-image img,
      .modal-image video {
        max-height: 40vh;
      }
      .modal-title {
        font-size: 1.75rem;
      }
      .modal-description {
        font-size: 1rem;
      }
    }
    @media (max-width: 768px) {
      .nav {
        right: 20px;
        top: 20px;
        gap: 15px;
      }
      .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      .nft-modal {
        padding: 1rem;
      }
      .modal-content {
        height: 100vh;
        width: 100vw;
        border-radius: 0;
      }
      .modal-inner {
        padding: 1rem;
        gap: 1rem;
      }
      .modal-close {
        top: 1rem;
        right: 1rem;
        width: 36px;
        height: 36px;
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <select class="lang-select">
      <option value="ja">JP</option>
      <option value="en" selected>EN</option>
    </select>
    <button class="connect-btn" data-translate="connectWallet">CONNECT</button>
    <!-- 追加：没入体験へ移動するタブ -->
    <a href="immersive.html" data-translate="enterWorld">ENTER</a>
    <a href="gallery.html" class="gallery-link" data-translate="gallery">VIEW GALLERY</a>
    <a href="about.html" data-translate="about">ABOUT</a>
  </nav>

  <!-- Gallery Container -->
  <div class="gallery-container">
    <div class="gallery-grid">
      <!-- NFT items are generated via JS -->
    </div>
  </div>

  <!-- NFT Detail Modal -->
  <div class="nft-modal" id="nftModal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-background"></div>
      <button class="modal-close">×</button>
      <div class="modal-inner">
        <div class="modal-image">
          <!-- 初期表示は画像、動画は非表示 -->
          <img id="modalImage" src="" alt="NFT Detail">
          <video id="modalVideo" style="display: none;" playsinline></video>
        </div>
        <div class="modal-info">
          <div class="modal-header">
            <div class="collection-row">
              <span class="collection-label" id="modalCollection"></span>
              <span id="modalNumber"></span>
            </div>
            <h2 class="modal-title" id="modalTitle"></h2>
          </div>
          <div class="modal-description" id="modalDescription"></div>
          <div class="modal-traits" id="modalTraits"></div>
          <div class="modal-details">
            <div class="detail-item">
              <span class="detail-label" data-translate="details.style">Style:</span>
              <span class="detail-value" id="modalStyle"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label" data-translate="details.method">Method:</span>
              <span class="detail-value" id="modalMethod"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label" data-translate="details.accessory">Accessory:</span>
              <span class="detail-value" id="modalAccessory"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Web3 Library -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
  <!-- Color Thief Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
  <script>
    // グローバルエラーハンドラー（予期せぬエラーをキャッチ）
    window.addEventListener('error', function(e) {
      console.error("Global error caught:", e.error || e.message);
    });

    // 翻訳用オブジェクト
    const translations = {
      en: {
        connectWallet: "CONNECT",
        gallery: "VIEW GALLERY",
        about: "ABOUT",
        enterWorld: "ENTER",
        search: "Search by name or number...",
        ui: {
          all: "All",
          recent: "Recent",
          popular: "Popular",
          trending: "Trending"
        },
        details: {
          style: "Style:",
          method: "Method:",
          accessory: "Accessory:"
        },
        traitsTitle: "Traits"
      },
      ja: {
        connectWallet: "ウォレット接続",
        gallery: "ギャラリーを見る",
        about: "このプロジェクトについて",
        enterWorld: "没入体験",
        search: "名前または番号で検索...",
        ui: {
          all: "すべて",
          recent: "新着",
          popular: "人気",
          trending: "トレンド"
        },
        details: {
          style: "スタイル:",
          method: "制作技法:",
          accessory: "装飾:"
        },
        traitsTitle: "特性"
      }
    };

    let currentLang = "en";

    document.addEventListener('DOMContentLoaded', function() {
      // NFTデータ定義 (#1～#30)
      const nftData = [
        {
          id: 1,
          title: "MIYABI #001: Aonami - The Inheritor of Ripples",
          description_en: "Aonami, hailing from a lineage of Kamakura textile artisans, upholds the ancient art of indigo dyeing. Calm as a deep ocean, he channels a fervent passion to fuse digital art with traditional techniques.",
          description_ja: "青波は鎌倉の染織職人の家系に生まれ、古来の藍染技法を受け継いでいます。深海のような静けさを持ちながら、デジタルアートと伝統技法の融合に情熱を注ぐ。",
          image: "assets/nft1.jpg",
          // Optional example video:
          video: "assets/nft1.mp4", 
          style: "Contemporary Shibori",
          method: "Digital Painting & Dyeing Fusion",
          accessory: "Kimono with Wave Pattern",
          collection: "MIYABI",
          traits: {
            personality_en: "Calm & Passionate",
            personality_ja: "穏やかで情熱的",
            specialty_en: "Indigo Dyeing",
            specialty_ja: "藍染",
            currentBase_en: "Tokyo",
            currentBase_ja: "東京",
            fourCharacterIdiom_en: "Aosio Dream Rhyme",
            fourCharacterIdiom_ja: "青藍夢韻"
          }
        },
        {
          id: 2,
          title: "MIYABI #002: Kakurin - The Swordmaster of Tradition",
          description_en: "Kakurin, descendant of a samurai lineage bearing the crane emblem, has been trained in swordsmanship since childhood.",
          description_ja: "鶴凛は鶴の家紋を持つ武家の末裔で、幼少より剣の修行を積んでいる。",
          image: "assets/nft2.jpg",
          video: "",
          style: "Samurai Urban",
          method: "Traditional Swordsmanship + Modern Security",
          accessory: "Crane Emblem",
          collection: "MIYABI",
          traits: {
            personality_en: "Polite & Proud",
            personality_ja: "礼儀正しく誇り高い",
            specialty_en: "Swordsmanship",
            specialty_ja: "剣術",
            currentBase_en: "Metropolis",
            currentBase_ja: "大都市",
            fourCharacterIdiom_en: "Crane Shadow Blade",
            fourCharacterIdiom_ja: "鶴影剣"
          }
        },
        {
          id: 3,
          title: "MIYABI #003: Kaguya - The Enigma of Moonlight",
          description_en: "Kaguya, rumored to have been born under a lunar eclipse, infuses her brushstrokes with lunar radiance.",
          description_ja: "月食の夜に生まれたと言い伝えられる輝夜は、月の輝きを筆致に映し出す。",
          image: "assets/nft3.jpg",
          video: "",
          style: "Moonlit Avant-garde",
          method: "Sumi-e & Digital Overlay",
          accessory: "Lunar Hairpin",
          collection: "MIYABI",
          traits: {
            personality_en: "Gentle & Mystical",
            personality_ja: "神秘的でやわらかい",
            specialty_en: "Moonlit Brush",
            specialty_ja: "月光筆",
            currentBase_en: "Kyoto",
            currentBase_ja: "京都",
            fourCharacterIdiom_en: "Moonlit Dream Path",
            fourCharacterIdiom_ja: "月夜幻道"
          }
        },
        {
          id: 4,
          title: "MIYABI #004: Tsubame - The Swift Ink Artisan",
          description_en: "Tsubame is known for her lightning-fast strokes, capturing fleeting emotions before they vanish.",
          description_ja: "燕は稲妻のように素早い筆運びで、消えゆく感情を一瞬のうちに描き上げる。",
          image: "assets/nft4.jpg",
          video: "",
          style: "Neo-Shodo",
          method: "Expressive Ink & Watercolor",
          accessory: "Swallow Feather Brush",
          collection: "MIYABI",
          traits: {
            personality_en: "Energetic & Precise",
            personality_ja: "活気に満ち正確",
            specialty_en: "Calligraphy Flashes",
            specialty_ja: "閃きの書道",
            currentBase_en: "Osaka",
            currentBase_ja: "大阪",
            fourCharacterIdiom_en: "Lightning Ink Fury",
            fourCharacterIdiom_ja: "閃筆怒涛"
          }
        },
        {
          id: 5,
          title: "MIYABI #005: Akanezora - The Twilight Artisan",
          description_en: "Akanezora weaves vivid sunsets into her art, bridging day and night with ethereal hues.",
          description_ja: "茜空は鮮烈な夕焼けを作品に織り込み、昼と夜を繋ぐ幻想的な色彩を生み出す。",
          image: "assets/nft5.jpg",
          // Example with video:
          video: "assets/nft5.mp4",
          style: "Vibrant Twilight",
          method: "Dye & Pastel Fusion",
          accessory: "Sunset Kimono Shawl",
          collection: "MIYABI",
          traits: {
            personality_en: "Warm & Reflective",
            personality_ja: "温かく思慮深い",
            specialty_en: "Sunset Dye",
            specialty_ja: "夕焼け染め",
            currentBase_en: "Hiroshima",
            currentBase_ja: "広島",
            fourCharacterIdiom_en: "Crimson Arc Horizon",
            fourCharacterIdiom_ja: "茜虹境"
          }
        },
        {
          id: 6,
          title: "MIYABI #006: Momiji - The Autumn Whisperer",
          description_en: "Momiji draws inspiration from autumn leaves, capturing their fleeting blaze in digital layering.",
          description_ja: "紅葉は秋の落ち葉からインスピレーションを得て、儚い紅の輝きをデジタルレイヤーに落とし込む。",
          image: "assets/nft6.jpg",
          video: "",
          style: "Falling Leaves Impression",
          method: "Digital Collage & Ink Wash",
          accessory: "Maple Leaf Headpiece",
          collection: "MIYABI",
          traits: {
            personality_en: "Melancholic & Passionate",
            personality_ja: "物悲しくも情熱的",
            specialty_en: "Foliage Hues",
            specialty_ja: "紅葉彩",
            currentBase_en: "Nara",
            currentBase_ja: "奈良",
            fourCharacterIdiom_en: "Fallen Leaf Elegy",
            fourCharacterIdiom_ja: "落葉哀歌"
          }
        },
        {
          id: 7,
          title: "MIYABI #007: Suzuhana - The Bellflower Muse",
          description_en: "Graceful as a bellflower, Suzuhana’s gentle strokes resonate with harmony and quietude.",
          description_ja: "鈴花は桔梗のように優美で、その穏やかな筆致は調和と静寂を響かせる。",
          image: "assets/nft7.jpg",
          video: "",
          style: "Floral Harmony",
          method: "Hand-Drawn Blossoms & Digital Tones",
          accessory: "Bellflower Pendant",
          collection: "MIYABI",
          traits: {
            personality_en: "Gentle & Harmonious",
            personality_ja: "優しく調和的",
            specialty_en: "Floral Patterns",
            specialty_ja: "花模様",
            currentBase_en: "Nagoya",
            currentBase_ja: "名古屋",
            fourCharacterIdiom_en: "Flower Bell Echo",
            fourCharacterIdiom_ja: "花鈴の響"
          }
        },
        {
          id: 8,
          title: "MIYABI #008: Kaishin - The Sea-Heart Visionary",
          description_en: "Kaishin merges oceanic themes with ethereal calligraphy, exploring the depths of the human heart.",
          description_ja: "海心は海洋のモチーフと幻想的な書道を融合させ、人間の心の奥深くを表現する。",
          image: "assets/nft8.jpg",
          video: "",
          style: "Marine Calligraphy",
          method: "Ink & Sea Salt Texture",
          accessory: "Coral Inkstone",
          collection: "MIYABI",
          traits: {
            personality_en: "Calm & Introspective",
            personality_ja: "静かで内省的",
            specialty_en: "Oceanic Inks",
            specialty_ja: "海墨",
            currentBase_en: "Fukuoka",
            currentBase_ja: "福岡",
            fourCharacterIdiom_en: "Ocean Heart Flow",
            fourCharacterIdiom_ja: "海心流転"
          }
        },
        {
          id: 9,
          title: "MIYABI #009: Yomichi - The Night-Path Virtuoso",
          description_en: "Yomichi thrives in the hush of midnight, weaving glowing lines against a backdrop of endless night.",
          description_ja: "夜道は深夜の静寂を好み、無限の闇に光る線を織り込む作品を得意とする。",
          image: "assets/nft9.jpg",
          video: "",
          style: "Nocturnal Minimalism",
          method: "Glow Ink & Black Canvas",
          accessory: "Lantern Earring",
          collection: "MIYABI",
          traits: {
            personality_en: "Mysterious & Patient",
            personality_ja: "神秘的で辛抱強い",
            specialty_en: "Midnight Glimmer",
            specialty_ja: "深夜の輝き",
            currentBase_en: "Yokohama",
            currentBase_ja: "横浜",
            fourCharacterIdiom_en: "Night Path Illume",
            fourCharacterIdiom_ja: "夜道幻灯"
          }
        },
        {
          id: 10,
          title: "MIYABI #010: Fuurin - The Resonant Spirit",
          description_en: "Fuurin’s art dances with the sound of wind chimes, transforming gentle breezes into visible form.",
          description_ja: "風鈴の作品は風鈴の音色とともに舞い、そよ風を可視化するかのように描き出す。",
          image: "assets/nft10.jpg",
          // Example with video:
          video: "assets/nft10.mp4",
          style: "Wind Chime Aesthetic",
          method: "Acrylic & Ambient Sound Waves",
          accessory: "Metallic Wind Bell",
          collection: "MIYABI",
          traits: {
            personality_en: "Joyful & Tranquil",
            personality_ja: "陽気で安らか",
            specialty_en: "Wind Sound Visualization",
            specialty_ja: "風音可視化",
            currentBase_en: "Sendai",
            currentBase_ja: "仙台",
            fourCharacterIdiom_en: "Wind Bell Serenade",
            fourCharacterIdiom_ja: "風鈴の調"
          }
        },
        {
          id: 11,
          title: "MIYABI #011: Harutsuki - The Spring Moon Poet",
          description_en: "Harutsuki captures the bloom of spring under moonlit nights, highlighting life's ephemeral beauty.",
          description_ja: "春月は月夜の下で咲く春の花を描き、その儚い美しさを強調する作品を作り上げる。",
          image: "assets/nft11.jpg",
          video: "",
          style: "Lunar Spring Fusion",
          method: "Soft Pastel & Ink Wash",
          accessory: "Moon Blossom Hair Ornament",
          collection: "MIYABI",
          traits: {
            personality_en: "Poetic & Delicate",
            personality_ja: "叙情的で繊細",
            specialty_en: "Night-Blooming Florals",
            specialty_ja: "夜咲き花",
            currentBase_en: "Kyushu",
            currentBase_ja: "九州",
            fourCharacterIdiom_en: "Moonlit Petal Verse",
            fourCharacterIdiom_ja: "月下花詩"
          }
        },
        {
          id: 12,
          title: "MIYABI #012: Kazehime - The Princess of Gales",
          description_en: "Kazehime’s swirling lines mimic gusts of wind, filling her canvases with dynamic movement.",
          description_ja: "風姫のうねるような線は風を模し、キャンバスを動感に溢れた世界へと変える。",
          image: "assets/nft12.jpg",
          video: "",
          style: "Spiraling Expression",
          method: "Vortex Brush & Spray Paint",
          accessory: "Wind Ribbon",
          collection: "MIYABI",
          traits: {
            personality_en: "Spirited & Bold",
            personality_ja: "活発で大胆",
            specialty_en: "Gale Dynamics",
            specialty_ja: "疾風力学",
            currentBase_en: "Kanazawa",
            currentBase_ja: "金沢",
            fourCharacterIdiom_en: "Cyclone Grace",
            fourCharacterIdiom_ja: "旋風優雅"
          }
        },
        {
          id: 13,
          title: "MIYABI #013: Shikimi - The Ink Alchemist",
          description_en: "Shikimi experiments with pigments and ink chemistry, forging new hues unseen in nature.",
          description_ja: "式美は顔料や墨の化学変化を探求し、自然界に存在しない新たな色彩を生み出す。",
          image: "assets/nft13.jpg",
          video: "",
          style: "Alchemical Splendor",
          method: "Chemically Reactive Paint & Ink",
          accessory: "Philosopher’s Brush",
          collection: "MIYABI",
          traits: {
            personality_en: "Curious & Innovative",
            personality_ja: "探究心旺盛で革新的",
            specialty_en: "Color Alchemy",
            specialty_ja: "色彩錬金術",
            currentBase_en: "Tsukuba",
            currentBase_ja: "つくば",
            fourCharacterIdiom_en: "Alchemy of Hue",
            fourCharacterIdiom_ja: "色彩錬成"
          }
        },
        {
          id: 14,
          title: "MIYABI #014: Ranpu - The Lantern Bearer",
          description_en: "Ranpu illuminates hidden corners of the soul with lantern-themed art, shining hope in darkness.",
          description_ja: "乱風はランタンをモチーフに、心の奥底の暗がりに希望の光を灯す作品を生み出す。",
          image: "assets/nft14.jpg",
          video: "",
          style: "Illumination Realism",
          method: "Oil Paint & Glowing Pigments",
          accessory: "Iron Lantern Clip",
          collection: "MIYABI",
          traits: {
            personality_en: "Bright & Compassionate",
            personality_ja: "明るく慈悲深い",
            specialty_en: "Light-Emitting Oils",
            specialty_ja: "発光油絵",
            currentBase_en: "Kobe",
            currentBase_ja: "神戸",
            fourCharacterIdiom_en: "Lantern Heart Light",
            fourCharacterIdiom_ja: "灯籠心光"
          }
        },
        {
          id: 15,
          title: "MIYABI #015: Takamine - The Spirit of Summits",
          description_en: "Takamine embodies lofty mountain peaks, depicting grand vistas that instill reverence and awe.",
          description_ja: "高嶺は壮大な山岳を象徴し、畏敬を抱かせる雄大な風景を描き出す。",
          image: "assets/nft15.jpg",
          // Example with video:
          video: "assets/nft15.mp4",
          style: "Grand Mountain Scape",
          method: "Layered Ink & Texture Knife",
          accessory: "Summit Headband",
          collection: "MIYABI",
          traits: {
            personality_en: "Stoic & Majestic",
            personality_ja: "厳粛で雄大",
            specialty_en: "Mountain Impressions",
            specialty_ja: "山岳表現",
            currentBase_en: "Nagano",
            currentBase_ja: "長野",
            fourCharacterIdiom_en: "Peak Reverence",
            fourCharacterIdiom_ja: "山巓尊崇"
          }
        },
        {
          id: 16,
          title: "MIYABI #016: Miyako - The Imperial Grace",
          description_en: "Miyako merges regal motifs with traditional patterns, reflecting an imperial grace in every piece.",
          description_ja: "雅は王朝のモチーフと伝統紋様を融合し、作品に皇室のような気品を漂わせる。",
          image: "assets/nft16.jpg",
          video: "",
          style: "Imperial Elegance",
          method: "Silk Screen & Gold Leaf",
          accessory: "Golden Headdress",
          collection: "MIYABI",
          traits: {
            personality_en: "Noble & Serene",
            personality_ja: "優雅で静謐",
            specialty_en: "Royal Patterns",
            specialty_ja: "王朝紋様",
            currentBase_en: "Kyoto Palace District",
            currentBase_ja: "京都御所周辺",
            fourCharacterIdiom_en: "Regal Artistry",
            fourCharacterIdiom_ja: "皇雅美術"
          }
        },
        {
          id: 17,
          title: "MIYABI #017: Nenju - The Meditative Carver",
          description_en: "Nenju’s tranquility is channeled into intricate carvings, imprinting spiritual calm into each piece.",
          description_ja: "念珠は深い静寂を糸口に細密な彫刻を行い、作品へと精神的な安らぎを刻み込む。",
          image: "assets/nft17.jpg",
          video: "",
          style: "Sculpted Serenity",
          method: "Wood Carving & Ink Rub",
          accessory: "Prayer Bead Bracelet",
          collection: "MIYABI",
          traits: {
            personality_en: "Serene & Reflective",
            personality_ja: "穏やかで思索的",
            specialty_en: "Zen Carving",
            specialty_ja: "禅彫",
            currentBase_en: "Mount Koya",
            currentBase_ja: "高野山",
            fourCharacterIdiom_en: "Meditative Form",
            fourCharacterIdiom_ja: "禅形象"
          }
        },
        {
          id: 18,
          title: "MIYABI #018: Yuzu - The Citrus Crafter",
          description_en: "Inspired by the bright tang of citrus, Yuzu’s art sparkles with uplifting colors and tangy warmth.",
          description_ja: "柚子は柑橘系の爽やかな刺激から着想を得て、明るく心弾む色彩と甘酸っぱい温もりを作品に落とし込む。",
          image: "assets/nft18.jpg",
          video: "",
          style: "Citrus Pop",
          method: "Acrylic Splatter & Airbrush",
          accessory: "Citrus Palette",
          collection: "MIYABI",
          traits: {
            personality_en: "Cheerful & Fresh",
            personality_ja: "朗らかで新鮮",
            specialty_en: "Tangy Hues",
            specialty_ja: "柑橘彩",
            currentBase_en: "Shikoku",
            currentBase_ja: "四国",
            fourCharacterIdiom_en: "Citrus Radiance",
            fourCharacterIdiom_ja: "柑光輝耀"
          }
        },
        {
          id: 19,
          title: "MIYABI #019: Mokuran - The Silent Timber",
          description_en: "Deep in ancient forests, Mokuran sculpts wooden canvases that echo the silent voice of nature.",
          description_ja: "木蘭は太古の森に分け入り、自然の静寂な声を映す木製キャンバスを彫り出す。",
          image: "assets/nft19.jpg",
          video: "",
          style: "Forest Aesthetic",
          method: "Wood Burn & Natural Pigments",
          accessory: "Engraved Wooden Pendants",
          collection: "MIYABI",
          traits: {
            personality_en: "Grounded & Reflective",
            personality_ja: "落ち着いて内省的",
            specialty_en: "Wooden Relief",
            specialty_ja: "木版レリーフ",
            currentBase_en: "Aomori",
            currentBase_ja: "青森",
            fourCharacterIdiom_en: "Silent Grove Muse",
            fourCharacterIdiom_ja: "静樹の詩"
          }
        },
        {
          id: 20,
          title: "MIYABI #020: Yozakura - The Midnight Bloom",
          description_en: "Yozakura excels in capturing cherry blossoms under moonlight, an ode to the silent beauty of spring nights.",
          description_ja: "夜桜は夜の月明かりに照らされる桜を描くことに長け、静かな春夜の美しさを讃える。",
          image: "assets/nft20.jpg",
          // Example with video:
          video: "assets/nft20.mp4",
          style: "Moonlit Sakura",
          method: "Glowing Ink & Watercolor",
          accessory: "Petal Hair Clip",
          collection: "MIYABI",
          traits: {
            personality_en: "Romantic & Mysterious",
            personality_ja: "ロマンチックで神秘的",
            specialty_en: "Moonlit Blossoms",
            specialty_ja: "夜桜",
            currentBase_en: "Tohoku",
            currentBase_ja: "東北",
            fourCharacterIdiom_en: "Night Flower Reverie",
            fourCharacterIdiom_ja: "夜花幻想"
          }
        },
        {
          id: 21,
          title: "MIYABI #021: Hisui - The Jade-Eyed Oracle",
          description_en: "Hisui’s emerald palette unveils hidden realms, as if gazing through precious jade into secret worlds.",
          description_ja: "翡翠はエメラルドグリーンの色彩を用い、宝石を通して隠された世界を覗き見るような作品を生み出す。",
          image: "assets/nft21.jpg",
          video: "",
          style: "Jade Vision",
          method: "Metallic Pastes & Glossy Ink",
          accessory: "Jade Eye Pendant",
          collection: "MIYABI",
          traits: {
            personality_en: "Enigmatic & Insightful",
            personality_ja: "謎めいて洞察力に富む",
            specialty_en: "Emerald Tones",
            specialty_ja: "翡翠色彩",
            currentBase_en: "Gifu",
            currentBase_ja: "岐阜",
            fourCharacterIdiom_en: "Jade Eye Revelation",
            fourCharacterIdiom_ja: "翠眼啓示"
          }
        },
        {
          id: 22,
          title: "MIYABI #022: Kirameki - The Glittering Edge",
          description_en: "Kirameki harnesses shimmering metallics, forging artworks that dazzle with hypnotic light play.",
          description_ja: "煌めきは金属的なきらめきを利用し、催眠的な光の演出で見る者を魅了する作品を作る。",
          image: "assets/nft22.jpg",
          video: "",
          style: "Metallic Shimmer",
          method: "Foil Stamping & Spray Glitter",
          accessory: "Silver Fan",
          collection: "MIYABI",
          traits: {
            personality_en: "Flashy & Confident",
            personality_ja: "華やかで自信家",
            specialty_en: "Metallic Reflections",
            specialty_ja: "金属反射",
            currentBase_en: "Tokyo",
            currentBase_ja: "東京",
            fourCharacterIdiom_en: "Gleaming Apex",
            fourCharacterIdiom_ja: "輝頂点"
          }
        },
        {
          id: 23,
          title: "MIYABI #023: Shiranui - The Phantom Glow",
          description_en: "Like elusive wisps of flame, Shiranui’s art flickers in and out of focus, capturing the ephemeral.",
          description_ja: "不知火の作品は儚く揺らめく炎のように現れては消え、儚さを映し出す。",
          image: "assets/nft23.jpg",
          video: "",
          style: "Wisp Impressionism",
          method: "Glow Pigments & Smoke Textures",
          accessory: "Foxfire Amulet",
          collection: "MIYABI",
          traits: {
            personality_en: "Elusive & Spiritual",
            personality_ja: "捉えどころなく神秘的",
            specialty_en: "Will-o'-the-wisp Effect",
            specialty_ja: "鬼火表現",
            currentBase_en: "Kumamoto",
            currentBase_ja: "熊本",
            fourCharacterIdiom_en: "Phantom Ember",
            fourCharacterIdiom_ja: "幻炎奇火"
          }
        },
        {
          id: 24,
          title: "MIYABI #024: Hikari - The Dawn Breaker",
          description_en: "Hikari’s bold works evoke the first rays of sunlight, full of optimism and new beginnings.",
          description_ja: "光は黎明の一筋の光を思わせる力強い作品で、希望と始まりを表現する。",
          image: "assets/nft24.jpg",
          video: "",
          style: "Radiant Abstract",
          method: "Bold Brush & Acrylic Glow",
          accessory: "Sunrise Ribbon",
          collection: "MIYABI",
          traits: {
            personality_en: "Optimistic & Daring",
            personality_ja: "前向きで大胆",
            specialty_en: "Daybreak Palette",
            specialty_ja: "夜明け色",
            currentBase_en: "Chiba",
            currentBase_ja: "千葉",
            fourCharacterIdiom_en: "Dawn’s Radiance",
            fourCharacterIdiom_ja: "暁光輝"
          }
        },
        {
          id: 25,
          title: "MIYABI #025: Kasei - The Fire Planet Crafter",
          description_en: "Infused with Martian shades, Kasei’s canvases pulse with otherworldly heat and cosmic imagination.",
          description_ja: "火星の色彩を纏った華星のキャンバスは、異世界の熱と宇宙的な想像力に満ちている。",
          image: "assets/nft25.jpg",
          // Example with video:
          video: "assets/nft25.mp4",
          style: "Cosmic Vigor",
          method: "Mixed Media & Planetary Textures",
          accessory: "Orbital Charm",
          collection: "MIYABI",
          traits: {
            personality_en: "Fiery & Visionary",
            personality_ja: "情熱的で先見的",
            specialty_en: "Cosmic Hues",
            specialty_ja: "宇宙色彩",
            currentBase_en: "Space VR Studio",
            currentBase_ja: "宇宙VRスタジオ",
            fourCharacterIdiom_en: "Planet Ember Arc",
            fourCharacterIdiom_ja: "惑星焔弧"
          }
        },
        {
          id: 26,
          title: "MIYABI #026: Nadeshiko - The Pink Blossom Icon",
          description_en: "Nadeshiko embodies the soft elegance of pink blossoms, championing refined yet gentle themes.",
          description_ja: "撫子は柔らかなピンクの花を象徴し、上品で優美なテーマを追求する。",
          image: "assets/nft26.jpg",
          video: "",
          style: "Blossom Couture",
          method: "Watercolor & Soft Pastel",
          accessory: "Flower Hairband",
          collection: "MIYABI",
          traits: {
            personality_en: "Graceful & Tender",
            personality_ja: "上品で優しい",
            specialty_en: "Blossom Gradients",
            specialty_ja: "花のグラデーション",
            currentBase_en: "Ueno Park",
            currentBase_ja: "上野公園",
            fourCharacterIdiom_en: "Petal Harmony",
            fourCharacterIdiom_ja: "花弁調和"
          }
        },
        {
          id: 27,
          title: "MIYABI #027: Arashi - The Storm Bringer",
          description_en: "Arashi harnesses the chaotic force of storms, layering thunderous textures and electric hues.",
          description_ja: "嵐は嵐のカオスな力を操り、雷鳴のようなテクスチャと電撃的な色彩を重ねる。",
          image: "assets/nft27.jpg",
          video: "",
          style: "Tempest Abstract",
          method: "Thick Acrylic & Lightning Brush",
          accessory: "Storm Bandana",
          collection: "MIYABI",
          traits: {
            personality_en: "Tempestuous & Intense",
            personality_ja: "荒々しく激烈",
            specialty_en: "Thunderous Layers",
            specialty_ja: "雷鳴の層",
            currentBase_en: "Typhoon Coast",
            currentBase_ja: "台風沿岸",
            fourCharacterIdiom_en: "Raging Storm Pulse",
            fourCharacterIdiom_ja: "荒嵐鼓動"
          }
        },
        {
          id: 28,
          title: "MIYABI #028: Yukine - The Snowfall Dancer",
          description_en: "Yukine’s gentle strokes evoke falling snow, capturing the hush and purity of winter’s embrace.",
          description_ja: "雪音は舞い散る雪を思わせる優しい筆致で、冬の静寂と純白を表現する。",
          image: "assets/nft28.jpg",
          video: "",
          style: "Snowy Serenity",
          method: "White Ink & Subtle Glitter",
          accessory: "Snowflake Shawl",
          collection: "MIYABI",
          traits: {
            personality_en: "Calm & Pure",
            personality_ja: "静穏で純粋",
            specialty_en: "Snowfall Detail",
            specialty_ja: "降雪表現",
            currentBase_en: "Sapporo",
            currentBase_ja: "札幌",
            fourCharacterIdiom_en: "Silent Snow Grace",
            fourCharacterIdiom_ja: "静雪雅舞"
          }
        },
        {
          id: 29,
          title: "MIYABI #029: Kurotsuki - The Eclipse Vanguard",
          description_en: "Kurotsuki embraces cosmic darkness in ink-laden works, revealing glimmers of light from the void.",
          description_ja: "黒月は宇宙の闇を墨の中に封じ込め、空虚からわずかな光を見出すような作品を生み出す。",
          image: "assets/nft29.jpg",
          video: "",
          style: "Eclipse Expressionism",
          method: "Deep Ink & Negative Space",
          accessory: "Eclipse Pendant",
          collection: "MIYABI",
          traits: {
            personality_en: "Brooding & Profound",
            personality_ja: "陰鬱で深遠",
            specialty_en: "Void Illumination",
            specialty_ja: "虚空照明",
            currentBase_en: "Hokkaido",
            currentBase_ja: "北海道",
            fourCharacterIdiom_en: "Eclipsed Glint",
            fourCharacterIdiom_ja: "月蝕微光"
          }
        },
        {
          id: 30,
          title: "MIYABI #030: Seiryu - The Azure Dragon’s Roar",
          description_en: "Seiryu channels the legendary Azure Dragon, unleashing fierce, swirling strokes of unstoppable momentum.",
          description_ja: "青龍は伝説の蒼き龍を象徴し、圧倒的な勢いのうねる筆致を解き放つ。",
          image: "assets/nft30.jpg",
          // Example with video:
          video: "assets/nft30.mp4",
          style: "Mythic Beast",
          method: "Large-scale Ink & Splatter",
          accessory: "Dragon Crest",
          collection: "MIYABI",
          traits: {
            personality_en: "Fierce & Regal",
            personality_ja: "荒々しくも威厳ある",
            specialty_en: "Dragon Swirls",
            specialty_ja: "龍の渦",
            currentBase_en: "Okinawa",
            currentBase_ja: "沖縄",
            fourCharacterIdiom_en: "Azure Spiral Force",
            fourCharacterIdiom_ja: "蒼龍渦力"
          }
        }
      ];

      // エラーハンドリング付きの openModal 関数
      function openModal(nft) {
        try {
          const modal = document.getElementById('nftModal');
          if (!modal) return;
          const modalImg = document.getElementById('modalImage');
          const modalVideo = document.getElementById('modalVideo');
          const modalInfo = document.querySelector('.modal-info');
          const modalContent = document.querySelector('.modal-content');
          // 初期状態：画像＋詳細情報表示、動画は非表示
          if(modalImg) {
            modalImg.style.display = 'block';
          }
          if(modalVideo) {
            modalVideo.style.display = 'none';
          }
          if(modalInfo) {
            modalInfo.style.display = '';
          }
          if(modalContent) {
            modalContent.classList.remove('video-active');
          }

          if(modalImg) {
            modalImg.src = nft.image;
            modalImg.alt = nft.title;
          }
          if(modalVideo) {
            modalVideo.src = nft.video ? nft.video : "";
          }
          const modalCollectionElem = document.getElementById('modalCollection');
          const modalNumberElem = document.getElementById('modalNumber');
          if (modalCollectionElem) {
              modalCollectionElem.textContent = nft.collection ? nft.collection.toUpperCase() : 'MIYABI';
          }
          if (modalNumberElem) {
              modalNumberElem.textContent = "#" + String(nft.id).padStart(4, '0');
          }
          document.getElementById('modalTitle').textContent = nft.title;
          // 説明文、style, method, accessory は現在の言語に応じて
          document.getElementById('modalDescription').textContent = nft["description_" + currentLang];
          document.getElementById('modalStyle').textContent = nft["style_" + currentLang] || nft.style;
          document.getElementById('modalMethod').textContent = nft["method_" + currentLang] || nft.method;
          document.getElementById('modalAccessory').textContent = nft["accessory_" + currentLang] || nft.accessory;
          updateTraits(nft);

          // 画像読み込み後、背景色抽出
          if(modalImg) {
            modalImg.onload = function() {
              try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = modalImg.width;
                canvas.height = modalImg.height;
                ctx.drawImage(modalImg, 0, 0);
                const imageData = ctx.getImageData(0, 0, 1, 1).data;
                const bgColor = "rgb(" + imageData[0] + ", " + imageData[1] + ", " + imageData[2] + ")";
                const modalBg = document.querySelector('.modal-background');
                if (modalBg) {
                    modalBg.style.backgroundColor = bgColor;
                }
                if (window.innerWidth <= 768) {
                    const modalOverlay = document.querySelector('.modal-overlay');
                    if (modalOverlay) {
                        modalOverlay.style.backgroundColor = bgColor;
                    }
                }
              } catch (e) {
                console.error("Error extracting background color:", e);
              }
            };
          }

          // 画像クリックで動画表示（動画が存在する場合）
          if(modalImg) {
            modalImg.onclick = function() {
              if(nft.video && modalVideo && modalVideo.src) {
                modalImg.style.display = 'none';
                modalVideo.style.display = 'block';
                if(modalInfo) {
                  modalInfo.style.display = 'none';
                }
                if(modalContent) {
                  modalContent.classList.add('video-active');
                }
                modalVideo.play().catch(err => console.error("Video play error:", err));
              }
            };
          }
          // 動画クリックで画像＋詳細情報表示に戻す
          if(modalVideo) {
            modalVideo.onclick = function() {
              modalVideo.pause();
              modalVideo.style.display = 'none';
              if(modalImg) {
                modalImg.style.display = 'block';
              }
              if(modalInfo) {
                modalInfo.style.display = '';
              }
              if(modalContent) {
                modalContent.classList.remove('video-active');
              }
            };
          }

          modal.style.display = 'flex';
          setTimeout(() => { modal.classList.add('active'); }, 10);
          document.body.style.overflow = 'hidden';
          setupModalEventListeners(modal);
        } catch (error) {
          console.error("Error in openModal:", error);
        }
      }

      function updateTraits(nft) {
        try {
          const modalTraits = document.getElementById('modalTraits');
          if (modalTraits && nft.traits) {
              const keysToShow = ["personality", "specialty", "currentBase", "fourCharacterIdiom"];
              let traitsHTML = '<h3>' + (translations[currentLang].traitsTitle || "Traits") + '</h3><div class="trait-list">';
              keysToShow.forEach(key => {
                  if(nft.traits[key + "_" + currentLang]){
                    traitsHTML += 
                      '<div class="trait-item">' +
                          '<span class="trait-type">' + getTraitLabel(key) + ':</span> ' +
                          '<span class="trait-value">' + nft.traits[key + "_" + currentLang] + '</span>' +
                      '</div>';
                  }
              });
              traitsHTML += '</div>';
              modalTraits.innerHTML = traitsHTML;
          } else if (modalTraits) {
              modalTraits.innerHTML = '';
          }
        } catch (error) {
          console.error("Error in updateTraits:", error);
        }
      }

      function getTraitLabel(key) {
          const labels = {
              personality: currentLang === "ja" ? "性格" : "Personality",
              specialty: currentLang === "ja" ? "専門" : "Specialty",
              currentBase: currentLang === "ja" ? "活動拠点" : "Base",
              fourCharacterIdiom: currentLang === "ja" ? "四字熟語" : "Idiom"
          };
          return labels[key] || key;
      }

      function setupModalEventListeners(modal) {
          try {
            const closeButton = modal.querySelector('.modal-close');
            if (closeButton) {
                closeButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                });
                closeButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal();
                });
                closeButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal();
                });
            }
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            };
            document.addEventListener('keydown', escHandler);
            modal._escHandler = escHandler;
          } catch (error) {
            console.error("Error in setupModalEventListeners:", error);
          }
      }

      function closeModal() {
          try {
            const modal = document.getElementById('nftModal');
            if (!modal) return;
            if (modal._escHandler) {
                document.removeEventListener('keydown', modal._escHandler);
                delete modal._escHandler;
            }
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
          } catch (error) {
            console.error("Error in closeModal:", error);
          }
      }

      function populateGallery() {
          try {
            const galleryGrid = document.querySelector('.gallery-grid');
            if (!galleryGrid) return;
            galleryGrid.innerHTML = '';
            nftData.forEach(nft => {
                const item = createGalleryItem(nft);
                galleryGrid.appendChild(item);
            });
          } catch (error) {
            console.error("Error in populateGallery:", error);
          }
      }

      function createGalleryItem(nft) {
          try {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.dataset.number = "#" + String(nft.id).padStart(4, '0');
            item.dataset.title = nft.title;
            const numberDiv = document.createElement('div');
            numberDiv.className = 'gallery-item-number';
            numberDiv.textContent = item.dataset.number;
            const img = document.createElement('img');
            img.src = nft.image;
            img.alt = nft.title;
            img.loading = 'lazy';
            img.onerror = function() {
                this.src = 'assets/placeholder.jpg';
            };
            item.appendChild(numberDiv);
            item.appendChild(img);
            item.addEventListener('click', () => {
                openModal(nft);
            });
            return item;
          } catch (error) {
            console.error("Error in createGalleryItem:", error);
          }
      }

      async function initializeWeb3() {
          try {
            if (typeof window.ethereum !== 'undefined') {
                window.web3 = new Web3(window.ethereum);
                const connectBtn = document.querySelector('.connect-btn');
                if (connectBtn) {
                    connectBtn.addEventListener('click', connectWallet);
                }
                window.ethereum.on('accountsChanged', handleAccountsChanged);
            }
          } catch (error) {
            console.error("Error in initializeWeb3:", error);
          }
      }

      async function connectWallet() {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            handleAccountsChanged(accounts);
          } catch (error) {
            console.error('Failed to connect wallet:', error);
          }
      }

      function handleAccountsChanged(accounts) {
          const connectBtn = document.querySelector('.connect-btn');
          if (!connectBtn) return;
          if (accounts.length === 0) {
              connectBtn.textContent = translations[currentLang].connectWallet;
          } else {
              const shortAddress = accounts[0].substring(0, 6) + "..." + accounts[0].substring(accounts[0].length - 4);
              connectBtn.textContent = shortAddress;
          }
      }

      function initializeLanguageToggle() {
          try {
            const langSelect = document.querySelector('.lang-select');
            if (langSelect) {
                langSelect.addEventListener('change', (e) => {
                    currentLang = e.target.value;
                    updateLanguage();
                });
                langSelect.addEventListener('input', (e) => {
                    currentLang = e.target.value;
                    updateLanguage();
                });
            }
            updateLanguage();
          } catch (error) {
            console.error("Error in initializeLanguageToggle:", error);
          }
      }

      function updateLanguage() {
          try {
            // data-translate属性を持つ要素の更新
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.dataset.translate;
                const translationPath = key.split('.');
                let translation = translations[currentLang];
                for (const path of translationPath) {
                    translation = translation?.[path];
                }
                if (translation) {
                    element.textContent = translation;
                }
            });
            const connectBtn = document.querySelector('.connect-btn');
            if (connectBtn && !connectBtn.textContent.includes('0x')) {
                connectBtn.textContent = translations[currentLang].connectWallet;
            }
            // モーダル内表示中の場合、説明文・詳細情報および特性を更新
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle && modalTitle.textContent) {
                const nft = nftData.find(nft => nft.title === modalTitle.textContent);
                if (nft) {
                    document.getElementById('modalDescription').textContent = nft["description_" + currentLang];
                    document.getElementById('modalStyle').textContent = nft["style_" + currentLang] || nft.style;
                    document.getElementById('modalMethod').textContent = nft["method_" + currentLang] || nft.method;
                    document.getElementById('modalAccessory').textContent = nft["accessory_" + currentLang] || nft.accessory;
                    updateTraits(nft);
                }
            }
          } catch (error) {
            console.error("Error in updateLanguage:", error);
          }
      }

      function isMobileDevice() {
          return window.innerWidth <= 768;
      }

      function optimizeForMobile() {
          try {
            if (isMobileDevice()) {
                const galleryGrid = document.querySelector('.gallery-grid');
                if (galleryGrid) {
                    // モバイル時は1列表示に変更
                    galleryGrid.style.gridTemplateColumns = '1fr';
                }
                const modalContent = document.querySelector('.nft-modal .modal-content');
                if (modalContent) {
                    modalContent.style.gridTemplateColumns = '1fr';
                }
            }
          } catch (error) {
            console.error("Error in optimizeForMobile:", error);
          }
      }

      function debounce(func, wait) {
          let timeout;
          return function(...args) {
              clearTimeout(timeout);
              timeout = setTimeout(() => func(...args), wait);
          };
      }

      function lazyLoadImages() {
          try {
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            });
            images.forEach(img => imageObserver.observe(img));
          } catch (error) {
            console.error("Error in lazyLoadImages:", error);
          }
      }

      function handleError(error, context) {
          console.error("Error in " + context + ":", error);
          const errorContainer = document.querySelector('.error-container');
          if (errorContainer) {
              errorContainer.textContent = (currentLang === "ja" ? "エラーが発生しました: " : "An error occurred: ") + error.message;
              errorContainer.style.display = 'block';
          }
      }

      try {
          populateGallery();
          initializeLanguageToggle();
          initializeWeb3();
          optimizeForMobile();
          lazyLoadImages();
          window.addEventListener('resize', debounce(() => {
              optimizeForMobile();
          }, 250));
      } catch (error) {
          handleError(error, 'application initialization');
      }
    });
  </script>
</body>
</html>
